"use strict";!function(e){var t,o={debug:!1,updateWidth:!0};function i(t,i){var n=this;n.elem=e(t),n.affected={},n.opts=e.extend({},o,i,n.elem.data()),"string"==typeof n.opts.allCollections&&(n.opts.allCollections=n.opts.allCollections.split(/\s*,\s*/)),n.init()}i.prototype.log=function(){var t,o=this;"undefined"!=typeof console&&o.opts.debug&&((t=e.makeArray(arguments)).unshift("LISTY: "),console.log.apply(o,t))},i.prototype.showMessage=function(t,o,i){e.pnotify({title:i,text:o,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:2e3})},i.prototype.hideMessages=function(){e.pnotify_remove_all()},i.prototype.init=function(){var t,o=this;o.id=o.elem.attr("id"),o.addButton=o.elem.find(".jqListyAdd"),o.revertButton=o.elem.find(".jqListyRevert"),o.saveButton=o.elem.find(".jqListySave");try{(t=o.elem.find(".jqListyParams").html())&&(o.listyParams=JSON.parse(t))}catch(e){console.error("failed to parse json listy params",t)}o.listyContainer=o.elem.find(".jqListyContainer"),o.elem.on("refresh.listy",(function(){o.updateWidth()})),o.elem.on("reload.listy",(function(){o.reload()})),o.elem.on("save.listy",(function(){o.save()})),o.elem.on("modified.listy",(function(){o.flagModified()})),e(document).on("changedCollection",(function(e,t){t.source===o.opts.source&&t.collection===o.opts.collection&&(o.log("got a changedCollection event with data=",t),o.flagModified(),o.reload())})),o.listyContainer.find(".jqListyItem").each((function(){var t=e(this).parent(),i=o.getItemData(t.attr("id"));t.data(i)})),o.listyContainer.sortable({connectWith:".jqListyEditable .jqListyContainer",distance:5,tolerance:"pointer",placeholder:"ui-sortable-placeholder jqListyPlaceholder",forcePlaceholderSize:!0,cursor:"move",activate:function(t,i){var n=i.sender.parent().data("listy"),s=e(this).parents(".jqListy:first"),a=o.opts.collectionValue,r=i.item.data();o.isEqual(n)||!r.allowed||r.allowed.includes(a)||s.addClass("jqListyDisabled")},deactivate:function(t,o){e(this).parents(".jqListy:first").removeClass("jqListyDisabled")},start:function(t,i){var n=e(i.placeholder),s=i.item.height();o.log("got a start in ",o.id),n.height(s),i.item.addClass("jqListySelected")},remove:function(){o.log("got a remove in "+o.id)},receive:function(t,i){var n=i.sender.parent().data("listy"),s=o.opts.collectionValue,a=i.item.data();if(o.log("got a receive in ",o.id),o.isEqual(n)||a.allowed&&!a.allowed.includes(s))return n.listyContainer.sortable("cancel"),n.updateModified(),o.listyContainer.sortable("cancel"),o.updateModified(),void o.showMessage("notice",e.i18n("Sorry, can't drop element here."));o.affected[n.id]=n,n.affected[o.id]=o},update:function(e,t){var i=t.sender;i?(i=i.parent().data("listy"),o.log("got an update to ",o.id,"from ",i.id)):o.log("got an update to ",o.id),o.updateModified(),o.opts.autoSave&&o.save().then((function(){i&&o.reload()}))},stop:function(e,t){t.item.removeClass("jqListySelected")}}).disableSelection(),o.initialSorting=o.listyContainer.sortable("toArray").join(","),o.updateWidth();var i=o.elem.find(".jqListyItemTools");o.listyContainer.children("li").each((function(){var t=e(this),o=i.clone().appendTo(t);t.hoverIntent({over:function(){o.fadeIn(500,(function(){o.css({opacity:1})}))},out:function(){o.stop(),o.css({display:"none",opacity:1})}})})),o.revertButton.on("click",(function(){return o.reload(),!1})),o.saveButton.on("click",(function(){return o.save(),!1})),o.elem.find(".jqListyDelete").on("click",(function(){var t=e(this).parents("li:first").data();return o.dialog({name:"listy::confirmdelete",title:e.i18n("Delete Listy Item"),data:{name:t.name,title:t.title||t.topic||t.url,source:o.opts.source,collection:o.opts.collection}}).then((function(i){e(i).children("form").ajaxSubmit({beforeSubmit:function(){o.elem.data("blockUI.isBlocked")||o.elem.block({message:""})},success:function(){e(document).trigger("changedCollection",{source:o.opts.source,collection:o.opts.collection,web:t.web,topic:t.topic,action:"delete"}),o.flagModified(),o.reload()},error:function(e){var t=JSON.parse(e.responseText).error.message;o.elem.unblock(),o.showMessage("error",t)}})})),!1}));var n=function(t){var i=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{load:"listyplugin",showcollections:o.opts.showCollections,topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")}),n=t.data();return o.dialog({url:i,name:"listy::edititem",data:{collection:o.opts.collection,allCollections:o.opts.allCollections,name:n.name,index:n.index,source:o.opts.source,summary:n.summary,title:n.title,web:n.web,topic:n.topic,url:n.url,type:n.type},methods:{renderCollections:function(){return o.renderCollections()}}}).then((function(t){e(t).children("form").ajaxSubmit({beforeSubmit:function(){o.elem.data("blockUI.isBlocked")||o.elem.block({message:""})},success:function(){e(document).trigger("changedCollection",{source:o.opts.source,collection:o.opts.collection,web:n.web,topic:n.topic,action:"edit"})},error:function(e){var t=JSON.parse(e.responseText).error.message;o.elem.unblock(),o.showMessage("error",t)}})})),!1};o.elem.find(".jqListyEdit").on("click",(function(){var t=e(this).parents("li:first");return n(t),!1})).each((function(){e(this).parent().parent().on("dblclick",(function(){return n(e(this)),!1}))})),o.addButton.add(o.elem.find(".jqListyAddHere")).on("click",(function(){var t,i=e(this),n=i.parents("li:first"),s=i.parents("li:first").next("li:first"),a="";return n.length?(t=n.data("index")-1,a=((s.length?o.getItemData(s.attr("id")).index-1:t+2)-t)/2+t):i.is(".top")&&(n=o.listyContainer.find("> li:first")).length&&(a=(t=n.data("index"))-1),o.dialog({url:foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{load:"listyplugin",showcollections:o.opts.showCollections,types:o.opts.itemTypes,topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")}),name:"listy::additem",data:{collection:o.opts.collection,allCollections:o.opts.allCollections,source:o.opts.source,summary:"",title:"",web:foswiki.getPreference("WEB"),topic:"",url:"",index:a},methods:{renderCollections:function(){return o.renderCollections()}}}).then((function(t){e(t).children("form").ajaxSubmit({success:function(){e(document).trigger("changedCollection",{source:o.opts.source,collection:o.opts.collection,web:foswiki.getPreference("WEB"),topic:foswiki.getPreference("TOPIC"),action:"add"})},error:function(e){var t=JSON.parse(e.responseText).error.message;o.showMessage("error",t)}})})),!1}))},i.prototype.getItemData=function(t){var o=this.elem.find("#"+t),i={};return o.find(".jqListyData").each((function(){i=e.extend(i,JSON.parse(e(this).html()))})),void 0===(i=i[t])?{}:(i.allowed=o.find(".jqListyItem").data("allowed"),"string"==typeof i.allowed&&(i.allowed=i.allowed.split(/\s*,\s*/)),i)},i.prototype.updateModified=function(){var e=this;e.isModified()?e.flagModified():e.unflagModified()},i.prototype.renderCollections=function(){var t=this,o=[];return e.each(t.opts.allCollections,(function(e,i){o.push("<label><input type='radio' class='foswikiRadio' name='collection' value='"+i+"' "+(i===t.opts.collection?"checked":"")+">"+i+"</label>")})),o.join("\n")},i.prototype.isModified=function(){return this.initialSorting!==this.listyContainer.sortable("toArray").join(",")},i.prototype.flagModified=function(){var e=this;e.modified=!0,e.opts.autoSave||(e.saveButton.show(),e.revertButton.show(),e.addButton.hide(),e.updateWidth())},i.prototype.updateWidth=function(){var e=this;e.opts.updateWidth&&(e.elem.css("min-width",""),window.setTimeout((function(){e.elem.css("min-width",e.elem.css("width"))})))},i.prototype.unflagModified=function(){var e=this;e.modified=!1,e.saveButton.hide(),e.revertButton.hide(),e.addButton.show()},i.prototype.reload=function(o){var i,n=this;return t?t.done((function(){return n.reload(o)})):(n.log("reloading ",n.id,"dontPropagate=",o),n.listyParams?n.modified?(n.unflagModified(),i=e.extend({name:"LISTY",web:foswiki.getPreference("WEB"),topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC"),render:"on"},n.listyParams),e.ajax({url:foswiki.getScriptUrl("rest","RenderPlugin","tag"),type:"POST",data:i,beforeSend:function(){n.elem.data("blockUI.isBlocked")||n.elem.block({message:""})},success:function(t){n.elem.find(".jqListyTml").remove(),n.elem.replaceWith(t),o||(e.each(n.affected,(function(e,t){t.reload()})),n.affected={}),e(document).trigger("reloaded",{source:n.opts.source,collection:n.opts.collection,web:t.web,topic:t.topic,action:"reload"})},error:function(e){var t;t=404!==e.status?JSON.parse(e.responseText).error.message:e.status+" "+e.statusText,n.showMessage("error",t)}})):(n.log("not modified"),e.Deferred().resolve().promise()):(n.log("hm, ... no listyParams"),e.Deferred().resolve().promise()))},i.prototype.save=function(){var o,i,n=this;return n.modified?t?t.done((function(){return t=void 0,n.save()})):(n.log("saveListy",n.id),o=n.listyContainer.sortable("toArray"),i=e.extend({topic:n.opts.source,sorting:o.join(",")},n.opts),n.elem.find(".jqListyData").each((function(){e.extend(i,JSON.parse(e(this).html()))})),t=e.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"ListyPlugin",method:"saveListy",params:i,beforeSend:function(){},success:function(){var e,o=Object.keys(n.affected)[0];n.opts.autoSave||(void 0!==o&&(e=n.affected[o],delete n.affected[o]),n.isEqual(e)?e.reload():e.save()),t=void 0},error:function(e){n.elem.unblock(),n.showMessage("error",e.error.message),t=void 0}})):(n.log("not modified"),e.Deferred().resolve().promise())},i.prototype.isEqual=function(e){return this.opts.source===e.opts.source&&this.opts.collection===e.opts.collection},i.prototype.dialog=function(t){var o=this,i={url:foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{load:"listyplugin",topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")}),name:void 0,title:e.i18n("Confirmation required"),okayText:e.i18n("OK"),okayIcon:"ui-icon-check",cancelText:e.i18n("Cancel"),cancelIcon:"ui-icon-cancel",width:"auto",modal:!0,position:{my:"center",at:"center",of:window},open:function(){},data:{}};return"string"==typeof t&&(t={data:{text:t}}),void 0!==(t=e.extend({},i,t)).name&&(void 0!==t.data.type&&(t.name+="::"+t.data.type),t.url+="&name="+t.name),o.hideMessages(),e.Deferred((function(i){e.loadTemplate({url:t.url}).then((function(n){e(n.render(t.data,t.methods)).dialog({buttons:[{text:t.okayText,icon:t.okayIcon,click:function(){return e(this).dialog("close"),i.resolve(this),!0}},{text:t.cancelText,icon:t.cancelIcon,click:function(){return e(this).dialog("close"),i.reject(),!1}}],open:function(){var n=e(this),s=n.data("title");void 0!==s&&n.dialog("option","title",s),n.find("input").on("keydown",(function(t){var o=e(this);o.is(".ui-autocomplete-input")&&o.data("ui-autocomplete").menu.element.is(":visible")||13===t.keyCode&&(t.preventDefault(),n.dialog("close"),i.resolve(n[0]))})),t.open.call(o,this,t.data)},focus:function(t,o){e(this).find(".listyFocus:first").focus()},close:function(){e(this).remove()},show:"fade",modal:t.modal,draggable:!0,resizable:!1,title:t.title,width:t.width,position:t.position})}),(function(e){o.showMessage("error",e.responseText)}))})).promise()},e.fn.listy=function(t){return this.each((function(){e.data(this,"listy")||e.data(this,"listy",new i(this,t))}))},e(".jqListyEditable").livequery((function(){var t=e(this),i=e.extend({},o,t.data());t.addClass("jqInitedListy").listy(i)}))}(jQuery),function(e){var t={debug:!1,dry:!1,autoSubscribe:!1,animationClass:"faa-flash animated"};function o(o,i){var n=this;n.elem=e(o),n.icon=n.elem.find(".listyFavButtonIcon"),n.label=n.elem.find(".listyFavButtonLabel"),n.opts=e.extend({},t,i,n.elem.data()),n.init()}o.prototype.log=function(){var t,o=this;"undefined"!=typeof console&&o.opts.debug&&((t=e.makeArray(arguments)).unshift("FAV: "),console.log.apply(o,t))},o.prototype.showMessage=function(t,o,i){e.pnotify({title:i,text:o,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:2e3})},o.prototype.hideMessages=function(){e.pnotify_remove_all()},o.prototype.setState=function(t){var o=this;function i(i){o.log("success response=",i),o._isSaving=!1,o.icon.children().removeClass(o.opts.animationClass),o.opts.isFavorite=t,o.flagState(t),o.log("triggering changedCollection"),e(document).trigger("changedCollection",{source:o.opts.source,collection:o.opts.collection,web:o.opts.web,topic:o.opts.topic,action:t?"add":"remove"})}function n(e){o.log("error response=",e),o._isSaving=!1,o.icon.children().removeClass(o.opts.animationClass),o.showMessage("error",e.error.message)}o.icon.children().addClass(o.opts.animationClass),o._isSaving=!0,o.opts.dry?window.setTimeout(i,1e3):t?(o.log("new favorite state=",t),e.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"ListyPlugin",method:"saveListyItem",params:{name:"",index:"-1",type:"topic",topic:o.opts.source,collection:o.opts.collection,listyWeb:o.opts.web,listyTopic:o.opts.topic,subscribe:!!o.opts.autoSubscribe||void 0},success:function(t){i(t),o.opts.name=t.result.name,o.showMessage("info",e.i18n("Added to favorites"))},error:function(e){n(e)}})):(o.log("remove favorite state=",t),e.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"ListyPlugin",method:"deleteListyItem",params:{name:o.opts.name,topic:o.opts.source,collection:o.opts.collection,subscribe:!o.opts.autoSubscribe&&void 0},success:function(t){i(t),o.log("success response=",t),o.opts.name="",o.showMessage("info",e.i18n("Removed from favorites"))},error:function(e){n(e)}}))},o.prototype.flagState=function(e){var t,o,i,n=this;void 0===e&&(e=n.opts.isFavorite),e?(t=n.opts.unfavicon,o=n.opts.unfavtext,i=n.opts.unfavtitle):(t=n.opts.favicon,o=n.opts.favtext,i=n.opts.favtitle),n.elem.attr("title",decodeURIComponent(i)),n.icon.html(decodeURIComponent(t)),n.label.html(decodeURIComponent(o))},o.prototype.toggleState=function(){this.setState(!this.opts.isFavorite)},o.prototype.init=function(){var t=this;t.log("opts=",t.opts),t.elem.on("click",(function(e){return t._isSaving?t.log("save in progress ... ignored click"):(t.log("clicked on favbutton"),t.toggleState()),e.stopPropagation(),!1})),e(document).on("changedCollection",(function(e,o){o.source===t.opts.source&&o.collection===t.opts.collection&&o.web===t.opts.web&&o.topic===t.opts.topic&&(t.log("got a changedCollection event with data=",o),void 0!==o.action&&("edit"===o.action||"add"===o.action?t.opts.isFavorite=!0:t.opts.isFavorite=!1,t.flagState()))}))},e.fn.favButton=function(t){return this.each((function(){e.data(this,"favButton")||e.data(this,"favButton",new o(this,t))}))},e(".jqFavButton").livequery((function(){var o=e(this),i=e.extend({},t,o.data());o.addClass("jqInitedFavButton").favButton(i)}))}(jQuery);
